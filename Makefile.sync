UPSTREAM=https://github.com/ggml-org/llama.cpp.git
WORKDIR=backend/llama/vendor
FETCH_HEAD=ec98e2002

.PHONY: help
help:
	@echo "Available targets:"
	@echo "    sync                 Sync with upstream repositories"
	@echo "    checkout             Checkout upstream repository"
	@echo "    apply-patches        Apply patches to local repository"
	@echo "    format-patches       Format patches from local repository"
	@echo "    clean                Clean local repository"
	@echo
	@echo "Example:"
	@echo "    make -f $(lastword $(MAKEFILE_LIST)) clean apply-patches sync"

.PHONY: sync
sync: backend/llama/build-info.cpp backend/ml/backend/ggml/ggml/src/ggml-metal/ggml-metal-embed.metal

backend/llama/build-info.cpp: backend/llama/build-info.cpp.in backend/llama/llama.cpp
	sed -e 's|@FETCH_HEAD@|$(FETCH_HEAD)|' <$< >$@

backend/ml/backend/ggml/ggml/src/ggml-metal/ggml-metal-embed.metal: backend/ml/backend/ggml/ggml
	go generate ./$(@D)

.PHONY: backend/llama/llama.cpp
backend/llama/llama.cpp: backend/llama/vendor
	rsync -arvzc --delete -f "include LICENSE" -f "merge $@/.rsync-filter" $(addprefix $<,/LICENSE /) $@

.PHONY: backend/ml/backend/ggml/ggml
backend/ml/backend/ggml/ggml: backend/llama/vendor
	rsync -arvzc --delete -f "include LICENSE" -f "merge $@/.rsync-filter" $(addprefix $<,/LICENSE /ggml/) $@

PATCHES=$(wildcard backend/llama/patches/*.patch)
PATCHED=$(join $(dir $(PATCHES)), $(addsuffix ed, $(addprefix ., $(notdir $(PATCHES)))))

.PHONY: apply-patches
.NOTPARALLEL:
apply-patches: $(PATCHED)

backend/llama/patches/.%.patched: backend/llama/patches/%.patch
	@if git -c user.name=nobody -c 'user.email=<>' -C $(WORKDIR) am -3 $(realpath $<); then \
		touch $@;                                                                           \
	else                                                                                    \
		echo "Patch failed. Resolve any conflicts then continue.";                          \
		echo "1. Run 'git -C $(WORKDIR) am --continue'";                                    \
		echo "2. Run 'make -f $(lastword $(MAKEFILE_LIST)) format-patches'";                \
		echo "3. Run 'make -f $(lastword $(MAKEFILE_LIST)) clean apply-patches'";           \
		exit 1;                                                                             \
	fi

.PHONY: checkout
checkout: $(WORKDIR)
	git -C $(WORKDIR) fetch
	git -C $(WORKDIR) checkout -f $(FETCH_HEAD)

$(WORKDIR):
	git clone $(UPSTREAM) $(WORKDIR)

.PHONY: format-patches
format-patches: backend/llama/patches
	git -C $(WORKDIR) format-patch \
		--no-signature \
		--no-numbered \
		--zero-commit \
		-o $(realpath $<) \
		$(FETCH_HEAD)

.PHONY: clean
clean: checkout
	@git -C $(WORKDIR) am --abort || true
	$(RM) backend/llama/patches/.*.patched

.PHONY: print-base
print-base:
	@echo $(FETCH_HEAD)
